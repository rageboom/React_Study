var request = require('request'),
	winston = require('winston');

module.exports=
{
	Write:function(type, text, status, csrf, history_data, assigned_to, user_id, type_id, uri, callback) 
	{
		var d = new Date();
		var payLoad = 
		{
		   type:type,
		   text:text,
		   status:status,
		   assigned_to:assigned_to,
		   user_id: user_id,
		   type_id:type_id,
		   csrf:csrf,
		   history_data:history_data
		};
		function validateData(data, response) 
		{
			winston.warn('Status Code: ' + response.statusCode);
			if(response.statusCode !== 200)
			{
				var valid = false;
			}
			else
			{
				var valid = true;
			}
			return valid;
		}
	
		var RequestDone = function(error, response, data) 
		{

			var isDefault = true;

			var parsedData;
			winston.info('----------------->'+data);
			try 
			{
				parsedData = JSON.parse(data);
			}
			catch(e) 
			{
				winston.warn('RequestDone: Unable to parse API response in WebServiceCall ');
			}

			if(error) 
			{
				callback(JSON.stringify(error), null);
			} 
			else if(!data) 
			{
				winston.error('RequestDone: Response is Empty');
				callback('Response is Empty', null);
			}
			else if(parsedData && parsedData.success && parsedData.error) {
				winston.error('RequestDone: ' + parsedData.error.message);
				callback(parsedData.error.message, null);
			}
			else
			{
				try
				{
					if(isDefault) {
						JSON.parse(data);
					}
					else {
						callback(null,data);
						return;
					}
				}
				catch(e)
				{
					callback(null,data);
					return;
				}

				if(validateData(JSON.parse(data), response)) 
				{
					winston.info('RequestDone: Returning valid data!');
					callback(null, JSON.parse(data));
				}
				else
				{
					winston.error('RequestDone: Data check failure');
					try
					{
		  				var errJSON = JSON.parse(data);
						if(errJSON.error)
							callback(errJSON.error);
						else
							callback('Data Check Failure', null);
					}
					catch(e)
					{
						callback('Data Check Failure', null);
					}
				}
			}
		};

		// Get the user config file
		var RequestURI=uri;
		// Get api url for logging to your server db
		// Do a web request to log the history
		var contentType = {'content-type' : 'application/json; charset=utf-8' };
		var jsonParams = JSON.stringify(payLoad);

		winston.info('----> WS POST to: ' + RequestURI);
		request.post({
			headers: contentType,
			url: RequestURI,
			body: jsonParams
		}, RequestDone);
	}
}